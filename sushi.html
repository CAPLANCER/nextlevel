Option Explicit

' === Merge tracker sheets into their respective main sheets ===
' 1. DataTable (from UiPath) has 2 columns: [MainSheet], [TrackerSheet]
' 2. For each pair:
'       - Find last used row in MainSheet
'       - Add 3 blank rows + "Tracker" label in Col A
'       - Copy all data from TrackerSheet (UsedRange only)
'       - Paste below label in MainSheet
'       - Delete TrackerSheet after copy

Public Sub MergeTrackers(dtMapping As Variant)
    Dim wb As Workbook
    Dim i As Long
    Dim mainName As String, trackerName As String
    Dim wsMain As Worksheet, wsTracker As Worksheet
    Dim lastRow As Long, pasteRow As Long
    Dim rngCopy As Range
    Dim dataArr As Variant

    Set wb = ThisWorkbook

    ' Convert DataTable to array if needed (UiPath usually passes a 2D Variant array)
    If TypeName(dtMapping) = "Object" Then
        MsgBox "Please ensure UiPath passes DataTable as Variant array."
        Exit Sub
    End If

    On Error Resume Next

    ' Loop through each mapping row
    For i = LBound(dtMapping, 1) To UBound(dtMapping, 1)
        mainName = Trim(dtMapping(i, 1))
        trackerName = Trim(dtMapping(i, 2))

        If mainName <> "" And trackerName <> "" Then
            Set wsMain = Nothing
            Set wsTracker = Nothing
            Set wsMain = wb.Sheets(mainName)
            Set wsTracker = wb.Sheets(trackerName)
            
            If Not wsMain Is Nothing And Not wsTracker Is Nothing Then
                ' Activate main sheet
                wsMain.Activate
                
                ' Find last used row
                If Application.WorksheetFunction.CountA(wsMain.Cells) = 0 Then
                    lastRow = 1
                Else
                    lastRow = wsMain.Cells.Find("*", , , , xlByRows, xlPrevious).Row
                End If
                
                ' Add 3 blank rows
                pasteRow = lastRow + 3
                wsMain.Cells(pasteRow, 1).Value = "Tracker"
                pasteRow = pasteRow + 1

                ' Copy data range from tracker sheet
                If Application.WorksheetFunction.CountA(wsTracker.Cells) > 0 Then
                    Set rngCopy = wsTracker.UsedRange
                    rngCopy.Copy
                    wsMain.Cells(pasteRow, 1).PasteSpecial xlPasteValues
                End If

                ' Delete tracker sheet
                Application.DisplayAlerts = False
                wsTracker.Delete
                Application.DisplayAlerts = True
            End If
        End If
    Next i

    Application.CutCopyMode = False
    MsgBox "All tracker sheets merged and deleted successfully.", vbInformation

End Sub
