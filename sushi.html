Option Explicit

Sub MergeTrackers_FromSchemeName()
    Dim wb As Workbook
    Dim wsMap As Worksheet
    Dim wsMain As Worksheet
    Dim wsTracker As Worksheet
    Dim lastRowMap As Long
    Dim i As Long
    Dim mainName As String, trackerName As String
    Dim foundCell As Range
    Dim startRow As Long, endRow As Long, lastCol As Long
    Dim pasteRow As Long
    Dim rngCopy As Range

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    Set wb = ThisWorkbook
    Set wsMap = wb.Sheets("Sheet1") ' Mapping sheet name â€” change if needed

    ' Find last row in mapping table (Main | Tracker)
    lastRowMap = wsMap.Cells(wsMap.Rows.Count, "A").End(xlUp).Row

    ' Loop through each mapping pair
    For i = 2 To lastRowMap
        mainName = Trim(wsMap.Cells(i, 1).Value)
        trackerName = Trim(wsMap.Cells(i, 2).Value)

        If mainName <> "" And trackerName <> "" Then
            On Error Resume Next
            Set wsMain = wb.Sheets(mainName)
            Set wsTracker = wb.Sheets(trackerName)
            On Error GoTo 0

            If Not wsMain Is Nothing And Not wsTracker Is Nothing Then
                ' === Find "Scheme Name" in tracker ===
                Set foundCell = wsTracker.Cells.Find(What:="Scheme Name", LookIn:=xlValues, LookAt:=xlPart, MatchCase:=False)

                If Not foundCell Is Nothing Then
                    startRow = Application.Max(1, foundCell.Row - 1)
                    endRow = wsTracker.Cells.Find("*", , , , xlByRows, xlPrevious).Row
                    lastCol = wsTracker.Cells.Find("*", , , , xlByColumns, xlPrevious).Column

                    Set rngCopy = wsTracker.Range(wsTracker.Cells(startRow, 1), wsTracker.Cells(endRow, lastCol))

                    ' === Find last used row in main sheet ===
                    Dim lastRowMain As Long
                    If Application.WorksheetFunction.CountA(wsMain.Cells) = 0 Then
                        lastRowMain = 1
                    Else
                        lastRowMain = wsMain.Cells.Find("*", , , , xlByRows, xlPrevious).Row
                    End If

                    ' === Add 3 blank rows and tracker label ===
                    pasteRow = lastRowMain + 3
                    wsMain.Cells(pasteRow, 1).Value = "Tracker (" & trackerName & ")"
                    wsMain.Cells(pasteRow, 1).Font.Bold = True
                    wsMain.Cells(pasteRow, 1).Font.Color = RGB(255, 255, 255)
                    wsMain.Cells(pasteRow, 1).Interior.Color = RGB(192, 80, 77) ' Orange Accent 2, Darker 25%

                    pasteRow = pasteRow + 1

                    ' === Copy and paste tracker data (with formatting) ===
                    rngCopy.Copy
                    wsMain.Cells(pasteRow, 1).PasteSpecial xlPasteAll
                    wsMain.Cells(pasteRow, 1).PasteSpecial xlPasteColumnWidths

                    Debug.Print "Copied from " & trackerName & ": " & rngCopy.Address
                Else
                    MsgBox "Keyword 'Scheme Name' not found in tracker sheet: " & trackerName, vbExclamation
                End If

                ' === Optional: Delete tracker sheet after copy ===
                wsTracker.Delete
            Else
                MsgBox "Missing sheet: " & mainName & " or " & trackerName, vbExclamation
            End If
        End If
    Next i

    Application.CutCopyMode = False
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True

    MsgBox "All tracker sheets merged successfully!", vbInformation
End Sub
