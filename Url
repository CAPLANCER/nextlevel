Option Explicit

Sub Extract_Subject_And_Body()

    Dim wsSrc As Worksheet, wsOut As Worksheet
    Dim lastRow As Long, outRow As Long
    Dim r As Long
    Dim txt As String
    Dim subjectText As String
    Dim bodyText As String
    Dim captureBody As Boolean

    Set wsSrc = ThisWorkbook.Sheets("ExtractItem")

    ' Prepare output sheet
    On Error Resume Next
    Set wsOut = ThisWorkbook.Sheets("ValidItem")
    On Error GoTo 0

    If wsOut Is Nothing Then
        Set wsOut = ThisWorkbook.Sheets.Add
        wsOut.Name = "ValidItem"
    Else
        wsOut.Cells.Clear
    End If

    wsOut.Range("A1").Value = "Subject"
    wsOut.Range("B1").Value = "Body"
    outRow = 2

    lastRow = wsSrc.Cells(wsSrc.Rows.Count, "A").End(xlUp).Row

    subjectText = ""
    bodyText = ""
    captureBody = False

    For r = 1 To lastRow

        txt = Trim(wsSrc.Cells(r, "A").Value)
        If txt = "" Then GoTo NextRow

        ' ---------------- SUBJECT EXTRACTION ----------------
        If subjectText = "" Then
            If InStr(1, txt, "Microsoft Outlook", vbTextCompare) > 0 _
               And InStr(1, txt, "Your message", vbTextCompare) > 0 Then

                subjectText = txt
                subjectText = Replace(subjectText, "Microsoft Outlook", "", , , vbTextCompare)
                subjectText = Left(subjectText, InStr(1, subjectText, "Your message", vbTextCompare) - 1)
                subjectText = Trim(subjectText)

                GoTo NextRow
            End If
        End If

        ' ---------------- BODY EXTRACTION ----------------
        If InStr(1, txt, "Your message", vbTextCompare) > 0 Then
            captureBody = True
        End If

        If captureBody Then
            bodyText = bodyText & " " & txt

            ' Stop body when mail id is found
            If InStr(1, txt, "@icicipruamc.com", vbTextCompare) > 0 Then
                GoTo WriteOutput
            End If
        End If

NextRow:
    Next r

WriteOutput:
    If subjectText <> "" Or bodyText <> "" Then
        wsOut.Cells(outRow, "A").Value = subjectText
        wsOut.Cells(outRow, "B").Value = Trim(bodyText)
    End If

    MsgBox "Subject and Body extracted successfully!", vbInformation

End Sub
