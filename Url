import requests
import json
import re

# --- Configuration ---
API_KEY = "YOUR_API_KEY_HERE"
FILE_URI = "https://your-api-endpoint/v1beta/files/example-uri-123" # <--- Paste your URI here
FILE_MIME = "text/plain" # Or "image/png" etc.

TIMEOUT_SECONDS = 120

PROXIES = {
    "http": "http://10.238.7.4:8080",
    "https": "http://10.238.7.4:8080"
}

def Generate_JSON_From_URI(uri, mime_type):
    # Update to your specific model endpoint
    url = f"https://your-nlp-endpoint/v1beta/models/gemini-1.5-flash:generateContent?key={API_KEY}"
    
    headers = {"Content-Type": "application/json"}
    
    # Precise prompt to ensure valid JSON output
    prompt_text = (
        "Analyze the provided file. Identify the source language and translate the content into English. "
        "Provide the result strictly in this JSON format:\n"
        "{\n"
        "  \"Language\": \"detected_language\",\n"
        "  \"TranslatedContent\": \"the_markdown_translated_content\"\n"
        "}\n"
        "Do not include any other text or explanation."
    )

    payload = {
        "contents": [{
            "parts": [
                {"fileData": {"mimeType": mime_type, "fileUri": uri}},
                {"text": prompt_text}
            ]
        }]
    }

    try:
        print(f"Connecting to LLM using URI: {uri}...")
        response = requests.post(
            url, 
            headers=headers, 
            json=payload, 
            proxies=PROXIES, 
            verify=False, 
            timeout=TIMEOUT_SECONDS
        )

        if response.status_code == 200:
            res_json = response.json()
            # Extract text from the Gemini response structure
            try:
                raw_text = res_json['candidates'][0]['content']['parts'][0]['text']
                return raw_text
            except (KeyError, IndexError):
                print("Error: Response structure was unexpected.")
                print(json.dumps(res_json, indent=2))
                return None
        else:
            print(f"Failed. Status: {response.status_code}")
            print(f"Response: {response.text}")
            return None

    except Exception as e:
        print(f"Request Error: {e}")
        return None

def Clean_JSON_Output(raw_string):
    """Removes markdown fences like ```json if the AI adds them."""
    try:
        # Find everything between the first '{' and the last '}'
        match = re.search(r'\{.*\}', raw_string, re.DOTALL)
        if match:
            return json.loads(match.group(0))
        return json.loads(raw_string)
    except Exception as e:
        print(f"Failed to parse JSON: {e}")
        print(f"Raw String: {raw_string}")
        return None

# --- Run ---
if __name__ == "__main__":
    raw_content = Generate_JSON_From_URI(FILE_URI, FILE_MIME)
    
    if raw_content:
        json_data = Clean_JSON_Output(raw_content)
        if json_data:
            print("\n--- GENERATED JSON ---")
            print(json.dumps(json_data, indent=4))
