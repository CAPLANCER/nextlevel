Option Explicit

Dim nextCheckTime As Date
Dim shownProcesses As Collection

Sub StartProcessMonitor()
    Set shownProcesses = New Collection
    CheckRunningProcess
End Sub

Sub StopProcessMonitor()
    On Error Resume Next
    Application.OnTime earliesttime:=nextCheckTime, procedure:="CheckRunningProcess", schedule:=False
    On Error GoTo 0
End Sub

Sub CheckRunningProcess()
    Dim ws As Worksheet
    Dim lastRow As Long, r As Long
    Dim currentTime As Date
    Dim processName As String, folderName As String
    Dim startTime As Date, endTime As Date
    Dim key As String
    Dim msg As String

    Set ws = ThisWorkbook.Sheets("NOVEMBER25")
    currentTime = Time
    lastRow = ws.Cells(ws.Rows.Count, "C").End(xlUp).Row

    On Error Resume Next
    For r = 2 To lastRow
        If IsDate(ws.Cells(r, "C").Value) Then
            startTime = TimeValue(ws.Cells(r, "C").Value)
            endTime = DateAdd("n", 10, startTime)
            processName = Trim(ws.Cells(r, "A").Value)
            folderName = Trim(ws.Cells(r, "B").Value)
            key = processName & "_" & Format(startTime, "h:mm AM/PM")

            If currentTime >= startTime And currentTime < endTime Then
                If Not ExistsInCollection(shownProcesses, key) Then
                    msg = "ðŸŸ¢ Process: " & processName & vbCrLf & _
                          "ðŸ“ Folder: " & folderName & vbCrLf & _
                          "â° Start Time: " & Format(startTime, "h:mm AM/PM")

                    ShowToast msg
                    shownProcesses.Add key, key
                End If
            End If
        End If
    Next r
    On Error GoTo 0

    nextCheckTime = Now + TimeSerial(0, 2, 0)
    Application.OnTime nextCheckTime, "CheckRunningProcess"
End Sub

Private Function ExistsInCollection(col As Collection, key As String) As Boolean
    On Error Resume Next
    Dim temp As Variant
    temp = col(key)
    ExistsInCollection = (Err.Number = 0)
    Err.Clear
    On Error GoTo 0
End Function

Sub ShowToast(msg As String)
    With ToastForm
        .lblMsg.Caption = msg
        .StartUpPosition = 0
        .Top = Application.Top + 50
        .Left = Application.Left + Application.Width - .Width - 30
        .Show vbModeless
    End With
End Sub

Sub CloseToast()
    On Error Resume Next
    Unload ToastForm
End Sub
