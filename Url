import requests
import os
import urllib3
import json

# ==========================================
# CONFIGURATION
# ==========================================
API_KEY = "YOUR_ACTUAL_API_KEY_HERE"
FILE_PATH = "your_file.txt" 
PROXY_URL = "http://10.10.1.10:3128" 

# ==========================================
# SETUP (The "Make it like Postman" part)
# ==========================================
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
os.environ['HTTP_PROXY'] = PROXY_URL
os.environ['HTTPS_PROXY'] = PROXY_URL
proxies = {"http": PROXY_URL, "https": PROXY_URL}

def upload_like_postman():
    url = f"https://generativelanguage.googleapis.com/upload/v1beta/files?key={API_KEY}"
    
    print(f"--- Uploading '{FILE_PATH}' as Postman ---")
    
    # 1. DEFINE HEADERS (This is what was missing!)
    # We copy these exactly from what Postman sends.
    headers = {
        'User-Agent': 'PostmanRuntime/7.32.0',
        'Accept': '*/*',
        'Connection': 'keep-alive',
        # Do NOT set 'Content-Type' manually here! 
        # Python must set it automatically to handle the file boundary.
    }

    try:
        with open(FILE_PATH, 'rb') as f:
            
            # 2. FILE PAYLOAD
            files_payload = {'file': (FILE_PATH, f, 'text/plain')}
            
            # 3. SEND REQUEST
            print("Sending request with Postman headers...")
            response = requests.post(
                url, 
                headers=headers,  # <--- WE ADDED THIS
                files=files_payload, 
                proxies=proxies, 
                verify=False, 
                timeout=60
            )
            
        # 4. HANDLE RESPONSE
        if response.status_code == 200:
            print("âœ… Success! (Python is now behaving like Postman)")
            data = response.json()
            uri = data['file']['uri']
            print(f"ðŸ“‚ File URI: {uri}")
            return uri
            
        else:
            print(f"âŒ Failed: {response.status_code}")
            print(f"   Response: {response.text}")
            
            # Debugging Tip:
            if "<html" in response.text:
                print("   (It looks like the Proxy is still blocking us with an HTML page)")

    except Exception as e:
        print(f"âŒ Error: {e}")

if __name__ == "__main__":
    upload_like_postman()
