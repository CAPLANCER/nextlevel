Option Explicit

Sub CopySchemeDataToSummary_AndClean()
    Dim wb As Workbook
    Dim wsSummary As Worksheet
    Dim ws As Worksheet
    Dim schemeName As String
    Dim lastRowSummary As Long
    Dim foundCell As Range
    Dim i As Long
    Dim copied As Boolean
    
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.DisplayAlerts = False
    
    Set wb = ThisWorkbook
    Set wsSummary = wb.Sheets("Summary")
    
    ' === Step 1: Copy matching rows into Summary ===
    lastRowSummary = wsSummary.Cells(wsSummary.Rows.Count, "A").End(xlUp).Row
    
    For i = 7 To lastRowSummary
        schemeName = Trim(wsSummary.Cells(i, "A").Value)
        copied = False
        
        If schemeName <> "" Then
            ' Loop through each sheet
            For Each ws In wb.Worksheets
                If ws.Name <> wsSummary.Name Then
                    ' âœ… Include sheets with "dir", "direct", or "additional" in their names
                    If InStr(1, LCase(ws.Name), "dir") > 0 _
                       Or InStr(1, LCase(ws.Name), "direct") > 0 _
                       Or InStr(1, LCase(ws.Name), "additional") > 0 Then
                       
                        ' Find exact match in Column A (case-sensitive)
                        Set foundCell = ws.Columns("A").Find(What:=schemeName, LookIn:=xlValues, LookAt:=xlWhole, MatchCase:=True)
                        
                        If Not foundCell Is Nothing Then
                            foundCell.EntireRow.Copy
                            wsSummary.Cells(i, "A").PasteSpecial xlPasteAll
                            wsSummary.Cells(i, "A").PasteSpecial xlPasteColumnWidths
                            copied = True
                            Exit For ' stop searching once found
                        End If
                    End If
                End If
            Next ws
        End If
    Next i
    
    Application.CutCopyMode = False

    ' === Step 2: Clean the Summary sheet ===
    Call CleanUp_SummarySheet
    
    Application.DisplayAlerts = True
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    
    MsgBox "Data copied and Summary cleaned successfully!", vbInformation
End Sub

' ======================================================================
' Helper Sub: Cleans Summary Sheet (deletes Rank, moves Corpus & Nav, clears formatting)
' ======================================================================
Private Sub CleanUp_SummarySheet()
    Dim ws As Worksheet
    Dim lastCol As Long, lastRow As Long
    Dim rankCol As Long, corpusCol As Long, navCol As Long
    Dim colName As String
    Dim i As Long
    Dim rngClear As Range
    
    Set ws = ThisWorkbook.Sheets("Summary")
    
    ' === Identify last column and row ===
    lastCol = ws.Cells(7, ws.Columns.Count).End(xlToLeft).Column
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    ' === Find and delete the "Rank" column ===
    rankCol = 0
    For i = 1 To lastCol
        colName = Trim(LCase(ws.Cells(7, i).Value))
        If colName = "rank" Then
            rankCol = i
            Exit For
        End If
    Next i
    
    If rankCol > 0 Then
        ws.Columns(rankCol).Delete
    End If
    
    ' Recalculate last column after deletion
    lastCol = ws.Cells(7, ws.Columns.Count).End(xlToLeft).Column
    
    ' === Find "Corpus" and "Nav" columns ===
    corpusCol = 0
    navCol = 0
    For i = 1 To lastCol
        colName = Trim(LCase(ws.Cells(7, i).Value))
        If colName = "corpus" Then corpusCol = i
        If colName = "nav" Then navCol = i
    Next i
    
    ' === Move "Corpus" to the end ===
    If corpusCol > 0 Then
        ws.Columns(corpusCol).Cut
        ws.Columns(lastCol + 1).Insert Shift:=xlToRight
        lastCol = ws.Cells(7, ws.Columns.Count).End(xlToLeft).Column
    End If
    
    ' Re-locate "Nav" after Corpus move
    navCol = 0
    For i = 1 To lastCol
        colName = Trim(LCase(ws.Cells(7, i).Value))
        If colName = "nav" Then navCol = i
    Next i
    
    ' === Move "Nav" to the end ===
    If navCol > 0 Then
        ws.Columns(navCol).Cut
        ws.Columns(lastCol + 1).Insert Shift:=xlToRight
    End If
    
    ' === Clear bold & fill color from A7 to last used cell ===
    Set rngClear = ws.Range("A7", ws.Cells(lastRow, ws.Cells(7, ws.Columns.Count).End(xlToLeft).Column))
    With rngClear
        .Font.Bold = False
        .Interior.ColorIndex = xlNone
    End With
End Sub
