import requests
import json
import re

# --- Configuration ---
API_KEY = "YOUR_API_KEY_HERE"
FILE_URI = "https://your-api-endpoint/v1beta/files/example-uri-123"
FILE_MIME = "text/plain" 

TIMEOUT_SECONDS = 120

PROXIES = {
    "http": "http://10.238.7.4:8080",
    "https": "http://10.238.7.4:8080"
}

def Generate_JSON_From_URI(uri, mime_type):
    url = f"https://your-nlp-endpoint/v1beta/models/gemini-1.5-flash:generateContent?key={API_KEY}"
    headers = {"Content-Type": "application/json"}
    
    prompt_text = (
        "Identify the language and translate to English. "
        "Return result STRICTLY as JSON: {\"Language\": \"...\", \"TranslatedContent\": \"...\"}"
    )

    payload = {
        "contents": [{
            "parts": [
                {"fileData": {"mimeType": mime_type, "fileUri": uri}},
                {"text": prompt_text}
            ]
        }]
    }

    try:
        print(f"Connecting via Proxy to LLM using URI: {uri}...")
        response = requests.post(
            url, 
            headers=headers, 
            json=payload, 
            proxies=PROXIES, 
            verify=False, 
            timeout=TIMEOUT_SECONDS
        )

        # CHECK 1: HTTP Status
        print(f"Server Status Code: {response.status_code}")

        if response.status_code == 200:
            # CHECK 2: Is it actually JSON?
            try:
                res_json = response.json()
                raw_text = res_json['candidates'][0]['content']['parts'][0]['text']
                return raw_text
            except Exception as e:
                print("--- ERROR: Response body was not the expected AI JSON ---")
                print(f"Raw Response Text: {response.text}") # THIS WILL SHOW THE HTML IF BLOCKED
                return None
        else:
            print(f"--- FAILED: HTTP {response.status_code} ---")
            print(f"Error Details: {response.text}")
            return None

    except Exception as e:
        print(f"--- CONNECTION ERROR: {e} ---")
        return None

def Clean_JSON_Output(raw_string):
    """Safely extracts JSON even if AI adds extra words or markdown fences."""
    if not raw_string:
        return None
    try:
        # Regex to find everything between the first '{' and last '}'
        match = re.search(r'\{.*\}', raw_string, re.DOTALL)
        json_str = match.group(0) if match else raw_string
        return json.loads(json_str)
    except Exception as e:
        print(f"Failed to parse JSON string: {e}")
        # Return a fallback dict so the program doesn't crash later
        return {"Language": "Error", "TranslatedContent": raw_string}

if __name__ == "__main__":
    raw_content = Generate_JSON_From_URI(FILE_URI, FILE_MIME)
    
    if raw_content:
        json_data = Clean_JSON_Output(raw_content)
        if json_data:
            print("\n--- FINAL JSON RESULT ---")
            print(json.dumps(json_data, indent=4))
