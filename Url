import requests
import mimetypes
import os
import json
import re

# --- Configuration ---
API_KEY = "YOUR_API_KEY_HERE"
FILE_PATH = r"C:\Users\Documents\sample_document.txt"  # Update this
OUTPUT_JSON_NAME = "translated_output.json"
TIMEOUT_SECONDS = 120

# Proxy Setup
PROXIES = {
    "http": "http://10.238.7.4:8080",
    "https": "http://10.238.7.4:8080"
}

def Generate_URI_For_Text(file_path):
    """Step 1: Upload file and handle potential proxy/format errors."""
    upload_url = f"https://your-api-endpoint/v1beta/files?key={API_KEY}"
    
    try:
        mime_type, _ = mimetypes.guess_type(file_path)
        mime_type = mime_type or 'text/plain'

        print(f"--- Uploading: {os.path.basename(file_path)} ---")

        with open(file_path, 'rb') as raw_file:
            files = {'file': (os.path.basename(file_path), raw_file, mime_type)}
            response = requests.post(
                upload_url, 
                files=files, 
                proxies=PROXIES, 
                verify=False,
                timeout=TIMEOUT_SECONDS
            )

            if response.status_code == 200:
                res = response.json()
                uri = res.get("file", {}).get("uri")
                print(f"Success! URI: {uri}")
                return uri, mime_type
            else:
                print(f"Upload Failed [{response.status_code}]: {response.text}")
                return None, None
    except Exception as e:
        print(f"Upload Connection Error: {e}")
        return None, None

def Generate_JSON_Content(uri, mime_type):
    """Step 2: Request translation from LLM using the URI."""
    gen_url = f"https://your-nlp-endpoint/v1beta/models/gemini-1.5-flash:generateContent?key={API_KEY}"
    
    prompt_text = (
        "Identify the source language and translate the content into English. "
        "Provide the result strictly in this JSON format: "
        "{\"Language\": \"detected_language\", \"TranslatedContent\": \"markdown_content\"}. "
        "Do not include any other text."
    )

    payload = {
        "contents": [{
            "parts": [
                {"fileData": {"mimeType": mime_type, "fileUri": uri}},
                {"text": prompt_text}
            ]
        }]
    }

    try:
        print("--- Generating Translation ---")
        response = requests.post(
            gen_url, 
            json=payload, 
            proxies=PROXIES, 
            verify=False, 
            timeout=TIMEOUT_SECONDS
        )

        if response.status_code == 200:
            res_json = response.json()
            # Navigating the response structure safely
            raw_text = res_json['candidates'][0]['content']['parts'][0]['text']
            return raw_text
        else:
            print(f"Generation Failed [{response.status_code}]: {response.text}")
            return None
    except Exception as e:
        print(f"LLM Connection Error: {e}")
        return None

def Clean_And_Save_JSON(raw_string, output_filename):
    """Step 3: Extract JSON from AI string and save to a file."""
    try:
        # Regex to find JSON object {}
        match = re.search(r'\{.*\}', raw_string, re.DOTALL)
        json_data = json.loads(match.group(0)) if match else json.loads(raw_string)
        
        # Save to file
        with open(output_filename, 'w', encoding='utf-8') as f:
            json.dump(json_data, f, indent=4, ensure_ascii=False)
            
        print(f"\n--- SUCCESS ---")
        print(f"Result saved to: {os.path.abspath(output_filename)}")
        return json_data
    except Exception as e:
        print(f"Error parsing or saving JSON: {e}")
        return None

# --- Main Execution Pipeline ---
if __name__ == "__main__":
    # 1. Start Upload
    file_uri, m_type = Generate_URI_For_Text(FILE_PATH)
    
    if file_uri:
        # 2. Start Generation
        raw_ai_output = Generate_JSON_Content(file_uri, m_type)
        
        if raw_ai_output:
            # 3. Clean and Save
            final_json = Clean_And_Save_JSON(raw_ai_output, OUTPUT_JSON_NAME)
            
            if final_json:
                print("\nPreview of JSON content:")
                print(f"Language: {final_json.get('Language')}")
                # Print only the first 100 characters of content as preview
                print(f"Content: {final_json.get('TranslatedContent')[:100]}...")
