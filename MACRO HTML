import requests
import json
import sys
import time
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

# ==========================================
# USER CONFIGURATION
# ==========================================
API_KEY = "YOUR_ACTUAL_API_KEY_HERE"
FILE_PATH = "your_document.pdf"
PROXY_URL = "http://10.10.1.10:3128"

TIMEOUT_SECONDS = 60
MODEL_NAME = "gemini-1.5-flash"

# Retry Settings
MAX_RETRIES = 5
RETRY_DELAY = 10  # seconds

# Session + Retry Adapter
def get_retry_session():
    session = requests.Session()

    retry = Retry(
        total=MAX_RETRIES,
        backoff_factor=2,  # exponential backoff: 1, 2, 4, 8...
        status_forcelist=[408, 429, 500, 502, 503, 504],
        allowed_methods=["GET", "POST"]
    )

    adapter = HTTPAdapter(max_retries=retry)

    session.mount("https://", adapter)
    session.mount("http://", adapter)

    return session


# Global session with retry
session = get_retry_session()

# Proxy dictionary
proxies = {
    "http": PROXY_URL,
    "https": PROXY_URL,
}

# ==========================================
# UPLOAD FILE WITH RETRIES
# ==========================================
def upload_file():
    url = f"https://generativelanguage.googleapis.com/upload/v1beta/files?key={API_KEY}"
    print(f"[Step 1] Uploading file with retry enabled: {FILE_PATH}")

    for attempt in range(1, MAX_RETRIES + 1):
        try:
            with open(FILE_PATH, "rb") as f:
                files = {"file": (FILE_PATH, f, "application/pdf")}

                response = session.post(
                    url,
                    files=files,
                    proxies=proxies,
                    timeout=TIMEOUT_SECONDS
                )

            if response.status_code == 200:
                file_uri = response.json()["file"]["uri"]
                print(" > Upload success! File URI:", file_uri)
                return file_uri

            elif response.status_code >= 500:
                print(f"   Server error {response.status_code}. Retrying...")

            else:
                print(f"   API error {response.status_code}: {response.text}")
                return None

        except requests.exceptions.RequestException as e:
            print(f"   Network error: {e}")

        if attempt < MAX_RETRIES:
            print(f"   Waiting {RETRY_DELAY}s before retrying upload...")
            time.sleep(RETRY_DELAY)
        else:
            print("   Upload failed after max retries.")
            return None


# ==========================================
# GENERATE CONTENT WITH RETRIES
# ==========================================
def generate_content(file_uri):
    url = f"https://generativelanguage.googleapis.com/v1beta/models/{MODEL_NAME}:generateContent?key={API_KEY}"

    headers = {"Content-Type": "application/json"}

    payload = {
        "contents": [
            {
                "role": "user",
                "parts": [
                    {"fileData": {"mimeType": "application/pdf", "fileUri": file_uri}},
                    {"text": "Analyze this document and provide a summary."}
                ]
            }
        ]
    }

    print(f"[Step 2] Sending request to model... (Retry enabled)")

    for attempt in range(1, MAX_RETRIES + 1):
        try:
            print(f" > Attempt {attempt}/{MAX_RETRIES}")

            response = session.post(
                url,
                headers=headers,
                json=payload,
                proxies=proxies,
                timeout=TIMEOUT_SECONDS
            )

            if response.status_code == 200:
                return response.json()

            elif response.status_code >= 500:
                print(f"   Server error {response.status_code}. Retrying...")

            else:
                print(f"   API error {response.status_code}: {response.text}")
                return None

        except requests.exceptions.Timeout:
            print(f"   Timeout (> {TIMEOUT_SECONDS}s).")
        except requests.exceptions.RequestException as e:
            print(f"   Network error: {e}")

        if attempt < MAX_RETRIES:
            print(f"   Waiting {RETRY_DELAY}s before retry...")
            time.sleep(RETRY_DELAY)
        else:
            print("   Model request failed after max retries.")
            return None


# ==========================================
# SAVE OUTPUT
# ==========================================
def save_output(data):
    if data:
        filename = "response_output.json"
        with open(filename, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=4)
        print(f"[Step 3] Saved response to {filename}")

        try:
            print("\n--- AI Response ---")
            print(data["candidates"][0]["content"]["parts"][0]["text"])
        except KeyError:
            print("Could not extract text.")


# ==========================================
# MAIN
# ==========================================
if __name__ == "__main__":
    uri = upload_file()
    if uri:
        result_json = generate_content(uri)
        save_output(result_json)
