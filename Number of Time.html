import re
import pdfplumber

PDF_PATH = "YourFile.pdf"
OUTPUT_PATH = "Call_Records.txt"

# ==========================
# âœ… REGEX PATTERNS
# ==========================

# Time of day (HH:MM:SS)
time_pattern = re.compile(r"\b\d{2}:\d{2}:\d{2}\b")

# Indian phone numbers (with or without +91 / leading 0)
phone_pattern = re.compile(r"(?:\+?91)?0?[6-9]\d{9}")

# ==========================
# âœ… SECTION DETECTION
# ==========================

def update_section(line, current):
    u = line.upper().strip()

    # âœ… CALL SECTIONS (Airtel, Vi, Jio)
    if "ITEMISED CALLS" in u or "ITEMIZED CALLS" in u:
        return "CALL"
    if "LOCAL CALLS HH:MM:SS" in u:
        return "CALL"
    if "STD CALLS HH:MM:SS" in u:
        return "CALL"
    if "VOICE SPECIAL NUMBERS HH:MM:SS" in u:
        return "CALL"
    if "OUTGOING CALLS" in u:
        return "CALL"
    if "VOICE CALLS COUNT" in u:
        return "CALL"

    # âœ… SMS SECTIONS
    if "SMS - LOCAL MESSAGES" in u:
        return "SMS"
    if u.startswith("SMS "):
        return "SMS"
    if "SMS BILLED USAGE" in u:
        return "SMS"

    # âœ… DATA / INTERNET SECTIONS
    if "INTERNET KBYTES" in u or "MOBILE INTERNET" in u or "DATA USAGE" in u:
        return "DATA"

    return current


# ==========================
# âœ… EXTRACTION
# ==========================

call_records = []
current_section = None

with pdfplumber.open(PDF_PATH) as pdf:
    for page in pdf.pages:
        text = page.extract_text()
        if not text:
            continue

        for line in text.split("\n"):
            # Update section based on headers
            current_section = update_section(line, current_section)

            # âœ… Skip if not in CALL section
            if current_section != "CALL":
                continue

            # âœ… Skip headers / totals
            l = line.strip().lower()
            if l.startswith(("s.no", "total", "subtotal", "description", "pulse", "amount")):
                continue

            # âœ… Must contain BOTH time and phone
            if not time_pattern.search(line):
                continue
            if not phone_pattern.search(line):
                continue

            # âœ… Passed all filters â†’ Valid call row
            call_records.append(line.strip())

# ==========================
# âœ… EXPORT TO TEXT
# ==========================

with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
    f.write("=== CALL RECORDS ===\n\n")
    for r in call_records:
        f.write(r + "\n")

print("âœ… Extraction complete!")
print(f"âœ… Saved to: {OUTPUT_PATH}")
print(f"ðŸ“Œ Total Call Records: {len(call_records)}")
