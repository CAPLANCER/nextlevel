Option Explicit

Public Function RunTransExtract() As String
    On Error GoTo ErrHandler

    Application.ScreenUpdating = False

    '=== Validate sheet ===
    If WorksheetExists("Trans extract") = False Then
        RunTransExtract = "Error: Sheet 'Trans extract' not found"
        Exit Function
    End If

    With Sheets("Trans extract")
        .Range("A7:AZ100000").ClearContents

        '=== Safe try QAAMacro.Logon ===
        On Error Resume Next
        QAAMacro.Logon
        If Err.Number <> 0 Then
            RunTransExtract = "Error: QAAMacro Add-in Missing"
            Err.Clear
            GoTo Cleanup
        End If
        On Error GoTo ErrHandler

        QAAMacro.RecalculateRange "B6"

        .Rows("1:1").EntireRow.Hidden = True

        ' Autofit range
        .Columns("C:AT").EntireColumn.AutoFit
    End With

    ' Wait until Excel finished calculating
    Call WaitForCalc

    RunTransExtract = "Success"
    GoTo Cleanup

ErrHandler:
    RunTransExtract = "Error: " & Err.Description

Cleanup:
    Application.ScreenUpdating = True
End Function


'=== helper to wait ===
Private Sub WaitForCalc()
    Do While Application.CalculationState <> xlDone
        DoEvents
    Loop
End Sub

'=== helper to check sheet ===
Private Function WorksheetExists(sName As String) As Boolean
    On Error Resume Next
    WorksheetExists = Not Sheets(sName) Is Nothing
    On Error GoTo 0
End Function
